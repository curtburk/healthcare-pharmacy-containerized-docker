# =============================================================================
# Medical AI Drug Interaction Demo - Docker Compose
#
# Usage:
#   ./start.sh --build             # First time / after code changes
#   ./start.sh                     # Subsequent runs
#   docker compose down            # Stop everything
#
# Prerequisites:
#   - NVIDIA Container Toolkit installed
#   - GGUF model file in ./models/ directory
# =============================================================================

services:
  healthcare-demo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: healthcare-drug-interaction-demo
    ports:
      - "8000:8000"
    volumes:
      # Mount models from host — keeps Docker image small (~25GB model stays on host)
      - ./models:/app/models:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MODEL_PATH=/app/models/medical-ft-mixtral-q4
      - TOKENIZERS_PARALLELISM=false
      - OMP_NUM_THREADS=8
      # Host IP for clickable URLs — auto-detected by start.sh
      - HOST_IP=${HOST_IP:-}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
